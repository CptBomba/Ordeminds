<!doctype html>
<html lang="pt-br"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ordeminds  Painel</title>
<link rel="icon" href="/assets/logo-mark.svg">
<link rel="stylesheet" href="/assets/style.css"/>
<script defer src="/assets/theme.js"></script>
<script defer src="/assets/app.js"></script>
</head><body>
<header><nav>
  <div class="logo-wrap">
    <img class="mark" src="/assets/logo-mark.svg" alt="logo"/>
    <img class="word-light" src="/assets/logo-wordmark-white.svg" alt="Ordeminds"/>
    <img class="word-dark"  src="/assets/logo-wordmark-dark.svg"  alt="Ordeminds"/>
  </div>
  <span class="spacer"></span>
  <button id="themeToggle" class="btn" onclick="toggleTheme()"></button>
  <a class="btn" data-role="loginBtn" href="/login">Entrar</a>
  <a class="btn primary" data-role="loginBtn" href="/signup">Criar conta</a>
  <span id="account"></span>
</nav></header>
<main class="layout">
  <aside class="sidebar">
    <div class="panel"><h3>Menu</h3>
      <div class="grid" style="grid-template-columns:1fr">
        <a class="btn" href="/app">Painel</a><a class="btn" href="/agenda">Agenda</a><a class="btn" href="/tasks">Tarefas</a><a class="btn" href="/shopping">Compras</a><a class="btn" href="/bills">Contas</a><a class="btn" href="/reports">Relatórios</a><a class="btn" href="/profile">Perfil</a>
      </div>
    </div>
  </aside>
  <section class="grid">
    <div class="panel" style="grid-column:1/3">
      <div class="row"><h2>Resumo</h2><span class="spacer"></span>
        <button class="btn" id="bell"> <span class="badge" id="bellDot" style="display:none">!</span></button>
      </div>
      <canvas id="spend" width="1000" height="260" style="width:100%;height:auto"></canvas>
    </div>
    <div class="panel"><h3>Calendário</h3><div id="month-mini"></div></div>
    <div class="panel"><h3>Hoje</h3><ul id="agenda" style="padding-left:1rem"></ul></div>
    <div class="panel"><h3>Tarefas</h3>
      <form onsubmit="addTask(event)"><div class="row"><input id="tinput" placeholder="Nova tarefa..."><button class="btn primary">Adicionar</button></div></form>
      <ul id="tasks" style="padding-left:1rem"></ul>
    </div>
    <div class="panel"><h3>Compras</h3>
      <form onsubmit="addShop(event)"><div class="row"><input id="sinput" placeholder="Adicionar item..."><button class="btn primary">OK</button></div></form>
      <ul id="shop" style="padding-left:1rem"></ul>
    </div>
    <div class="panel"><h3>Contas</h3>
      <form onsubmit="addBill(event)"><div class="row"><input id="btitle" placeholder="Descrição"><input id="bval" type="number" step="0.01" placeholder="Valor"><input id="bdate" type="date"><button class="btn primary">OK</button></div></form>
      <ul id="bills" style="padding-left:1rem"></ul>
    </div>
  </section>
</main>
<script>
function fmt(n){return n.toString().padStart(2,"0")}
async function loadAgenda(){const now=new Date(); const to=new Date(now); to.setHours(23,59,59,999);
  const r=await fetch(`/api/events?from=${now.toISOString()}&to=${to.toISOString()}`); const a= r.ok? await r.json():[];
  agenda.innerHTML=""; for(const e of a){const li=document.createElement("li");const dt=new Date(e.start_at); li.textContent=`${fmt(dt.getHours())}:${fmt(dt.getMinutes())} ${e.title}`; agenda.appendChild(li);}}
async function addTask(e){e.preventDefault(); if(!tinput.value.trim())return; await fetch("/api/tasks",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:tinput.value})}); tinput.value=""; loadTasks();}
async function addShop(e){e.preventDefault(); if(!sinput.value.trim())return; await fetch("/api/shopping",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:sinput.value})}); sinput.value=""; loadShop();}
async function addBill(e){e.preventDefault(); if(!btitle.value||!bval.value||!bdate.value)return; await fetch("/api/bills",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:btitle.value, amount:parseFloat(bval.value), due_date:bdate.value})}); btitle.value=""; bval.value=""; bdate.value=""; loadBills(); chart();}
document.addEventListener("click",async e=>{
  if(e.target.matches("input[type='checkbox'][data-id]")){await fetch("/api/tasks/"+e.target.dataset.id,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({completed:e.target.checked})});}
  if(e.target.matches("button[data-del]")){await fetch("/api/tasks/"+e.target.dataset.del,{method:"DELETE"}); loadTasks();}
  if(e.target.matches("input[type='checkbox'][data-sid]")){await fetch("/api/shopping/"+e.target.dataset.sid,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({done:e.target.checked})});}
  if(e.target.matches("button[data-sdel]")){await fetch("/api/shopping/"+e.target.dataset.sdel,{method:"DELETE"}); loadShop();}
  if(e.target.matches("input[type='checkbox'][data-bid]")){await fetch("/api/bills/"+e.target.dataset.bid,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({paid:e.target.checked})}); chart(); }
  if(e.target.matches("button[data-bdel]")){await fetch("/api/bills/"+e.target.dataset.bdel,{method:"DELETE"}); loadBills(); chart();}
});
async function loadTasks(){const r=await fetch("/api/tasks"); const a= r.ok? await r.json():[]; tasks.innerHTML=""; for(const t of a){const li=document.createElement("li"); li.innerHTML=`<input type="checkbox" ${t.completed?"checked":""} data-id="${t.id}"> ${t.title} <button class="btn" data-del="${t.id}">x</button>`; tasks.appendChild(li);}}
async function loadShop(){const r=await fetch("/api/shopping"); const a= r.ok? await r.json():[]; shop.innerHTML=""; for(const t of a){const li=document.createElement("li"); li.innerHTML=`<input type="checkbox" ${t.done?"checked":""} data-sid="${t.id}"> ${t.title} <button class="btn" data-sdel="${t.id}">x</button>`; shop.appendChild(li);}}
async function loadBills(){const r=await fetch("/api/bills"); const a= r.ok? await r.json():[]; bills.innerHTML=""; for(const b of a){const li=document.createElement("li"); const d=new Date(b.due_date); li.innerHTML=`${b.title}  R$ ${( +b.amount).toFixed(2)}  ${d.toLocaleDateString()} <input type="checkbox" ${b.paid?"checked":""} data-bid="${b.id}"> <button class="btn" data-bdel="${b.id}">x</button>`; bills.appendChild(li);}}
async function chart(){const y=new Date().getFullYear(); const r=await fetch("/api/expenses/summary?year="+y); const data= r.ok? await r.json():[];
  const cvs=document.getElementById("spend"); const ctx=cvs.getContext("2d"); ctx.clearRect(0,0,cvs.width,cvs.height);
  const margin=40, W=cvs.width, H=cvs.height, w=W-margin*2, h=H-margin*2;
  const months=["J","F","M","A","M","J","J","A","S","O","N","D"]; const max=Math.max(1,...data.map(v=>v.total));
  ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue("--card"); ctx.fillRect(0,0,W,H);
  ctx.strokeStyle="rgba(255,255,255,.25)"; ctx.beginPath(); ctx.moveTo(margin, margin); ctx.lineTo(margin, H-margin); ctx.lineTo(W-margin, H-margin); ctx.stroke();
  const barw = w/12 * .6; const gap = w/12 * .4;
  data.forEach((m,i)=>{const x=margin + i*(barw+gap) + gap/2; const y=H-margin - (m.total/max)*h; ctx.fillStyle="#1AC6B2"; ctx.fillRect(x,y,barw,(m.total/max)*h); ctx.fillStyle="#b9d4ff"; ctx.fillText(months[i], x+barw/3, H-margin+14); });
}
async function alerts(){const r=await fetch("/api/alerts"); const a= r.ok? await r.json():{total:0,items:[]}; const dot=document.getElementById("bellDot"); dot.style.display=a.total>0?"inline-block":"none"; dot.textContent=a.total;}
document.addEventListener("DOMContentLoaded",()=>{ drawMonthCalendar("month-mini", new Date().getFullYear(), new Date().getMonth()); loadAgenda(); loadTasks(); loadShop(); loadBills(); chart(); alerts(); });
</script>
</body></html>
