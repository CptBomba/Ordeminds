<!doctype html><html lang="pt-br"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ordeminds ‚Äî Painel</title>
<link rel="icon" href="/favicon-32.png">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="stylesheet" href="/assets/style.css"/>
<script defer src="/assets/theme.js"></script>
</head><body><header><nav>
<div class="logo-wrap">
  <img class="mark" src="/assets/logo-mark-hc.png" alt="logo"/>
  <img class="word-light" src="/assets/logo-wordmark-white.png" alt="Ordeminds"/>
  <img class="word-dark" src="/assets/logo-wordmark-dark.png" alt="Ordeminds"/>
</div>
<span class="spacer"></span>
<button id="themeToggle" class="btn"></button>
<a class="btn" href="/login">Entrar</a>
<a class="btn primary" href="/signup">Criar conta</a>
</nav></header>
<main class="dash">
  <section class="panel">
    <div class="row"><div class="clock" id="clock"></div><span class="spacer"></span>
      <button class="btn bell" id="bell">üîî<span class="dot" id="bellDot" style="display:none">!</span></button>
    </div>
    <canvas id="spend" width="900" height="280" style="width:100%;height:auto;margin:.8rem 0;background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:12px"></canvas>
    <div class="grid">
      <div class="card"><h3>üìÖ Hoje</h3><ul id="agenda" style="padding-left:1rem"></ul></div>
      <div class="card"><h3>‚è±Ô∏è Tarefas</h3>
        <form onsubmit="addTask(event)"><div class="row"><input id="tinput" placeholder='Nova tarefa...'><button>Adicionar</button></div></form>
        <ul id="tasks" style="padding-left:1rem"></ul>
      </div>
      <div class="card"><h3>üõí Compras</h3>
        <form onsubmit="addShop(event)"><div class="row"><input id="sinput" placeholder='Adicionar item...'><button>OK</button></div></form>
        <ul id="shop" style="padding-left:1rem"></ul>
      </div>
      <div class="card"><h3>üí∏ Contas</h3>
        <form onsubmit="addBill(event)"><div class="row"><input id="btitle" placeholder='Descri√ß√£o'><input id="bval" type="number" step="0.01" placeholder='Valor'><input id="bdate" type="date"><button>OK</button></div></form>
        <ul id="bills" style="padding-left:1rem"></ul>
      </div>
    </div>
  </section>
  <aside class="right">
    <div class="panel">
      <h3>Calend√°rio</h3>
      <div class="calendar" id="cal"></div>
    </div>
    <div class="panel">
      <h3>Novo compromisso</h3>
      <form onsubmit="addEvent(event)">
        <input id="etitle" placeholder="T√≠tulo" required>
        <div class="row"><input id="estart" type="datetime-local" required><input id="eend" type="datetime-local"></div>
        <input id="eloc" placeholder="Local (opcional)">
        <div class="row"><input id="erem" type="number" min="0" step="5" placeholder="Lembrar (min antes)"><button>Salvar</button></div>
      </form>
    </div>
  </aside>
</main>
<script>
function fmt(n){return n.toString().padStart(2,'0')}
function tick(){const d=new Date();clock.textContent=`${fmt(d.getHours())}:${fmt(d.getMinutes())}:${fmt(d.getSeconds())}`}
setInterval(tick,1000); tick();

async function drawCalendar(date=new Date()){
  const cal=document.getElementById('cal'); cal.innerHTML='';
  const y=date.getFullYear(), m=date.getMonth();
  const first=new Date(y,m,1), last=new Date(y,m+1,0);
  const days=['D','S','T','Q','Q','S','S']; for(const d of days){const h=document.createElement('div');h.className='hd';h.textContent=d;cal.appendChild(h);}
  const pad=first.getDay(); for(let i=0;i<pad;i++){const c=document.createElement('div'); c.className='cell'; c.style.opacity=.3; cal.appendChild(c);}
  for(let day=1; day<=last.getDate(); day++){const c=document.createElement('div'); c.className='cell'; c.textContent=day; if(day===new Date().getDate() && m===new Date().getMonth() && y===new Date().getFullYear()) c.style.outline='2px solid var(--brand-teal)'; cal.appendChild(c);}
}
drawCalendar();

async function loadAgenda(){
  const now=new Date(); const to=new Date(now); to.setHours(23,59,59,999);
  const r=await fetch(`/api/events?from=${now.toISOString()}&to=${to.toISOString()}`);
  const a=await r.json(); agenda.innerHTML=''; for(const e of a){const li=document.createElement('li');const dt=new Date(e.start_at);li.textContent=`${fmt(dt.getHours())}:${fmt(dt.getMinutes())} ${e.title}`; agenda.appendChild(li);}
}
async function addEvent(ev){ev.preventDefault(); const body={title:etitle.value,start_at:estart.value, end_at:eend.value, location:eloc.value, reminder_min:parseInt(erem.value||'0',10)}; await fetch('/api/events',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)}); etitle.value=''; eloc.value=''; erem.value=''; loadAgenda(); alerts(); }

async function loadTasks(){const r=await fetch('/api/tasks'); if(!r.ok){location='/login';return;} const a=await r.json(); tasks.innerHTML=''; for(const t of a){const li=document.createElement('li'); li.innerHTML=`<input type="checkbox" ${t.completed?'checked':''} data-id="${t.id}"> ${t.title} <button data-del="${t.id}">x</button>`; tasks.appendChild(li);}}
async function addTask(e){e.preventDefault(); if(!tinput.value.trim())return; await fetch('/api/tasks',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({title:tinput.value})}); tinput.value=''; loadTasks();}

async function loadShop(){const r=await fetch('/api/shopping'); const a=await r.json(); shop.innerHTML=''; for(const t of a){const li=document.createElement('li'); li.innerHTML=`<input type="checkbox" ${t.done?'checked':''} data-sid="${t.id}"> ${t.title} <button data-sdel="${t.id}">x</button>`; shop.appendChild(li);}}
async function addShop(e){e.preventDefault(); if(!sinput.value.trim())return; await fetch('/api/shopping',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({title:sinput.value})}); sinput.value=''; loadShop();}

async function loadBills(){const r=await fetch('/api/bills'); const a=await r.json(); bills.innerHTML=''; for(const b of a){const li=document.createElement('li'); const d=new Date(b.due_date); li.innerHTML=`${b.title} ‚Äî R$ ${(+b.amount).toFixed(2)} ‚Äî ${d.toLocaleDateString()} <input type="checkbox" ${b.paid?'checked':''} data-bid="${b.id}"> <button data-bdel="${b.id}">x</button>`; bills.appendChild(li);}}
async function addBill(e){e.preventDefault(); if(!btitle.value||!bval.value||!bdate.value)return; await fetch('/api/bills',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({title:btitle.value, amount:parseFloat(bval.value), due_date:bdate.value})}); btitle.value=''; bval.value=''; bdate.value=''; loadBills(); chart();}

document.addEventListener('click',async e=>{
  if(e.target.matches('input[type="checkbox"][data-id]')){await fetch('/api/tasks/'+e.target.dataset.id,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({completed:e.target.checked})});}
  if(e.target.matches('button[data-del]')){await fetch('/api/tasks/'+e.target.dataset.del,{method:'DELETE'}); loadTasks();}
  if(e.target.matches('input[type="checkbox"][data-sid]')){await fetch('/api/shopping/'+e.target.dataset.sid,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({done:e.target.checked})});}
  if(e.target.matches('button[data-sdel]')){await fetch('/api/shopping/'+e.target.dataset.sdel,{method:'DELETE'}); loadShop();}
  if(e.target.matches('input[type="checkbox"][data-bid]')){await fetch('/api/bills/'+e.target.dataset.bid,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({paid:e.target.checked})}); chart(); }
  if(e.target.matches('button[data-bdel]')){await fetch('/api/bills/'+e.target.dataset.bdel,{method:'DELETE'}); loadBills(); chart();}
});

async function chart(){const y=new Date().getFullYear(); const r=await fetch('/api/expenses/summary?year='+y); const data=await r.json();
  const cvs=document.getElementById('spend'); const ctx=cvs.getContext('2d'); ctx.clearRect(0,0,cvs.width,cvs.height);
  const margin=40, W=cvs.width, H=cvs.height, w=W-margin*2, h=H-margin*2;
  const months=['J','F','M','A','M','J','J','A','S','O','N','D']; const max=Math.max(1,...data.map(v=>v.total));
  ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--card'); ctx.fillRect(0,0,W,H);
  ctx.strokeStyle = 'rgba(255,255,255,.25)'; ctx.beginPath(); ctx.moveTo(margin, margin); ctx.lineTo(margin, H-margin); ctx.lineTo(W-margin, H-margin); ctx.stroke();
  const barw = w/12 * .6; const gap = w/12 * .4;
  data.forEach((m,i)=>{const x=margin + i*(barw+gap) + gap/2; const y=H-margin - (m.total/max)*h; ctx.fillStyle='#1AC6B2'; ctx.fillRect(x,y,barw,(m.total/max)*h); ctx.fillStyle='#b9d4ff'; ctx.fillText(months[i], x+barw/3, H-margin+14); });
}

async function alerts(){const r=await fetch('/api/alerts'); const a=await r.json(); const dot=document.getElementById('bellDot'); dot.style.display=a.total>0?'inline-block':'none'; dot.textContent=a.total;}
bell.addEventListener('click', async ()=>{const r=await fetch('/api/alerts'); const a=await r.json(); alert(a.items.map(i=>i.text).join('\n') || 'Sem alertas');});

window.addEventListener('DOMContentLoaded',()=>{loadAgenda(); loadTasks(); loadShop(); loadBills(); chart(); alerts();});
</script>
</body></html>